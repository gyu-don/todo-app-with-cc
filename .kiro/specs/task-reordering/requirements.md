# Requirements Document

## Project Description (Input)
task-reordering ドラッグ&ドロップまたはボタンでTodoタスクの順序を変更できる機能。並び替えた順序はローカルストレージに永続化される。フロントエンドとバックエンドの実装が必要

## Introduction

タスク並び替え機能は、ユーザーがTodoアイテムの表示順序を自由にカスタマイズできるようにする機能です。ドラッグ&ドロップによる直感的な操作、またはボタンによる明示的な順序変更を提供し、ユーザーの優先順位や作業フローに合わせたタスク管理を可能にします。並び替えた順序はバックエンドストレージに永続化され、デバイスやセッションをまたいで一貫した順序を維持します。

この機能により、ユーザーは重要なタスクを上部に配置したり、関連するタスクをグループ化したりすることで、タスク管理の効率を向上させることができます。

## Requirements

### Requirement 1: タスク順序の管理
**Objective:** ユーザーとして、Todoタスクの表示順序を変更できるようにしたい。これにより、自分の優先順位や作業フローに合わせてタスクを整理できる。

#### Acceptance Criteria

1. WHEN Todoシステムがタスクを保存する THEN Todoシステム SHALL 各タスクに固有の順序インデックス（position）を割り当てる
2. WHEN Todoシステムが新しいタスクを作成する THEN Todoシステム SHALL そのタスクを現在のリストの最後の位置に配置する
3. WHEN Todoシステムがタスクを削除する THEN Todoシステム SHALL 削除されたタスクより後ろの位置にあるタスクの順序インデックスを自動的に調整する
4. WHEN Todoシステムがタスク一覧を取得する THEN Todoシステム SHALL タスクを順序インデックスの昇順でソートして返す

### Requirement 2: ドラッグ&ドロップによる並び替え
**Objective:** ユーザーとして、ドラッグ&ドロップ操作でタスクの順序を直感的に変更できるようにしたい。これにより、素早く効率的にタスクを整理できる。

#### Acceptance Criteria

1. WHEN ユーザーがタスク項目をマウスでドラッグ開始する THEN Todoフロントエンド SHALL そのタスク項目を視覚的にドラッグ状態として表示する
2. WHILE ユーザーがタスク項目をドラッグ中である THE Todoフロントエンド SHALL ドロップ可能な位置を視覚的に示す
3. WHEN ユーザーがタスク項目を新しい位置にドロップする THEN Todoフロントエンド SHALL その位置にタスクを移動し、バックエンドに順序更新をリクエストする
4. WHEN ユーザーがドラッグ操作をキャンセルする（Escキー押下または無効な位置へのドロップ） THEN Todoフロントエンド SHALL タスクを元の位置に戻す
5. WHEN タッチデバイスでユーザーがタスク項目をロングプレスする THEN Todoフロントエンド SHALL ドラッグ&ドロップモードを開始する

### Requirement 3: ボタンによる並び替え
**Objective:** ユーザーとして、ボタン操作でタスクの順序を変更できるようにしたい。これにより、ドラッグ&ドロップが困難な環境（モバイル、アクセシビリティツール使用時）でもタスクを整理できる。

#### Acceptance Criteria

1. WHERE 各タスク項目に THE Todoフロントエンド SHALL 「上へ移動」「下へ移動」のボタンを表示する
2. WHEN ユーザーが「上へ移動」ボタンをクリックする AND そのタスクが最上位でない THEN Todoフロントエンド SHALL タスクを一つ上の位置に移動し、バックエンドに順序更新をリクエストする
3. WHEN ユーザーが「下へ移動」ボタンをクリックする AND そのタスクが最下位でない THEN Todoフロントエンド SHALL タスクを一つ下の位置に移動し、バックエンドに順序更新をリクエストする
4. WHEN タスクが最上位にある THEN Todoフロントエンド SHALL 「上へ移動」ボタンを無効化する
5. WHEN タスクが最下位にある THEN Todoフロントエンド SHALL 「下へ移動」ボタンを無効化する
6. WHEN キーボードユーザーがボタンにフォーカスする THEN Todoフロントエンド SHALL 視覚的なフォーカスインジケータを表示する

### Requirement 4: バックエンドAPI
**Objective:** システムとして、タスクの順序変更をRESTful APIで処理できるようにしたい。これにより、フロントエンドとバックエンドの責任を明確に分離し、将来的な拡張性を確保できる。

#### Acceptance Criteria

1. WHEN Todoシステムが順序更新リクエストを受信する THEN Todoバックエンド SHALL リクエストボディに`taskId`と`newPosition`を要求する
2. WHEN Todoバックエンドが有効な順序更新リクエストを受信する THEN Todoバックエンド SHALL 指定されたタスクの位置を更新し、影響を受ける他のタスクの位置を再計算する
3. WHEN 順序更新が成功する THEN Todoバックエンド SHALL 更新された全タスクリストをレスポンスとして返す
4. WHEN 指定されたタスクIDが存在しない THEN Todoバックエンド SHALL 404 Not Foundエラーを返す
5. WHEN 指定された新しい位置が範囲外である（0未満または最大タスク数より大きい） THEN Todoバックエンド SHALL 400 Bad Requestエラーを返す
6. WHEN 複数の順序更新リクエストを一括で受信する THEN Todoバックエンド SHALL すべての更新をアトミックに処理する

### Requirement 5: データ永続化
**Objective:** システムとして、タスクの順序をバックエンドストレージに永続化したい。これにより、ユーザーがデバイスやセッションを変更しても一貫した順序を維持できる。

#### Acceptance Criteria

1. WHEN Todoバックエンドがタスクの順序を更新する THEN Todoバックエンド SHALL 更新された順序をWorkers KVストレージに保存する
2. WHEN Todoバックエンドがタスクリストを取得する THEN Todoバックエンド SHALL ストレージから順序インデックスを含むタスクデータを読み込む
3. IF Workers KVへの書き込みが失敗した THEN Todoバックエンド SHALL エラーをログに記録し、500 Internal Server Errorをクライアントに返す
4. WHEN 同一ユーザーが複数デバイスからアクセスする THEN Todoシステム SHALL 最新の順序情報を一貫して提供する

### Requirement 6: UIフィードバックとユーザーエクスペリエンス
**Objective:** ユーザーとして、並び替え操作の進行状況と結果を明確に理解できるようにしたい。これにより、操作が成功したか失敗したかを確認でき、安心してシステムを使用できる。

#### Acceptance Criteria

1. WHEN ユーザーが並び替え操作を実行する THEN Todoフロントエンド SHALL 即座にUIを更新し、楽観的更新（Optimistic Update）を実行する
2. WHILE バックエンドへの順序更新リクエストが進行中である THE Todoフロントエンド SHALL ローディングインジケータを表示する
3. WHEN バックエンドから順序更新の成功レスポンスを受信する THEN Todoフロントエンド SHALL 成功フィードバック（例：短時間の成功メッセージまたはアニメーション）を表示する
4. WHEN バックエンドから順序更新の失敗レスポンスを受信する THEN Todoフロントエンド SHALL タスクリストを元の状態にロールバックし、エラーメッセージを表示する
5. WHEN ネットワークエラーが発生する THEN Todoフロントエンド SHALL タスクリストを元の状態にロールバックし、再試行オプションを提供する
6. WHEN ユーザーが順序変更を実行する THEN Todoフロントエンド SHALL スムーズなアニメーションでタスクの位置変更を表示する

### Requirement 7: アクセシビリティ
**Objective:** すべてのユーザーとして、能力や使用するツールに関わらず、タスクの並び替え機能にアクセスできるようにしたい。これにより、WCAG 2.1 AA基準に準拠したアクセシブルなアプリケーションを提供できる。

#### Acceptance Criteria

1. WHEN スクリーンリーダーユーザーがタスク項目にフォーカスする THEN Todoフロントエンド SHALL タスクの現在位置と総タスク数を読み上げる（例：「3つ中1番目のタスク」）
2. WHEN キーボードユーザーがタスク項目にフォーカスする THEN Todoフロントエンド SHALL キーボードショートカット（例：Ctrl+↑/↓）でタスクを移動できるようにする
3. WHEN ユーザーがキーボードでタスクを移動する THEN Todoフロントエンド SHALL スクリーンリーダーに移動完了を通知する（例：「タスクを2番目に移動しました」）
4. WHERE ドラッグ&ドロップインターフェースに THE Todoフロントエンド SHALL 代替のキーボード操作方法を提供する
5. WHEN ユーザーが並び替えボタンを使用する THEN Todoフロントエンド SHALL 適切なARIAラベルとロールを設定する

### Requirement 8: パフォーマンスと最適化
**Objective:** システムとして、タスクの並び替え操作を高速かつ効率的に処理したい。これにより、大量のタスクがある場合でもスムーズなユーザーエクスペリエンスを提供できる。

#### Acceptance Criteria

1. WHEN ユーザーが並び替え操作を実行する THEN Todoフロントエンド SHALL 100ミリ秒以内にUI更新を完了する
2. WHEN タスクリストに100個以上のタスクがある THEN Todoフロントエンド SHALL 仮想スクロールまたは遅延ロードを使用してパフォーマンスを維持する
3. WHEN バックエンドが順序更新を処理する THEN Todoバックエンド SHALL 50ミリ秒以内（P95）にストレージアクセスを完了する
4. WHEN ユーザーが短時間に複数回並び替え操作を実行する THEN Todoフロントエンド SHALL リクエストをデバウンスまたはスロットリングして不要なAPI呼び出しを防ぐ
