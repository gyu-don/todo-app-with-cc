# 実装計画

## タスク概要

このドキュメントは、タスク並び替え機能の実装タスクを定義します。各タスクは要件と設計に基づいており、テスト駆動開発（TDD）の原則に従って実装されます。

---

## 実装タスク

- [ ] 1. データモデルとストレージ層の拡張
- [x] 1.1 Todoモデルにpositionフィールドを追加
  - Todoインターフェースに`position: number`フィールドを追加
  - position値は0から始まる連続した整数として定義
  - 型定義とバリデーションルールを実装
  - _Requirements: 1.1_

- [x] 1.2 既存Todoタスクへの自動position割り当て機能を実装
  - 既存のTodo取得時、positionフィールドがない場合に自動割り当て
  - 割り当て後にWorkers KVへ自動保存
  - position順でのソート機能を実装
  - _Requirements: 1.1, 1.4_

- [x] 1.3 タスク作成時に最後の位置へ自動配置する機能を実装
  - 新規タスク作成時、現在のタスク総数をpositionとして設定
  - 既存のcreateメソッドを拡張
  - _Requirements: 1.2_

- [x] 1.4 タスク削除時に順序インデックスを自動調整する機能を実装
  - 削除されたタスクより後ろの位置にあるタスクのpositionを-1
  - 既存のdeleteメソッドを拡張
  - _Requirements: 1.3_

- [ ] 2. 並び替えロジックの実装
- [x] 2.1 タスク位置再計算アルゴリズムを実装
  - 上方向移動時（oldPosition > newPosition）の位置再計算ロジック
  - 下方向移動時（oldPosition < newPosition）の位置再計算ロジック
  - 影響を受けるタスクのposition値を自動調整
  - 位置変更がない場合の早期リターン処理
  - _Requirements: 1.1, 4.2_

- [x] 2.2 複数タスクの位置を一括更新する機能を実装
  - ストレージ層にupdatePositionsメソッドを追加
  - Workers KVへの並列書き込み機能
  - 更新後の全タスクリストをposition順で返却
  - _Requirements: 4.2, 4.6, 5.1_

- [ ] 3. バックエンドAPIの実装
- [x] 3.1 並び替えリクエストのバリデーション機能を実装
  - todoIdのUUID v4形式検証
  - newPositionの範囲チェック（0以上、タスク総数未満）
  - リクエストボディの必須フィールド検証
  - _Requirements: 4.1, 4.4, 4.5_

- [x] 3.2 並び替えハンドラーを実装
  - ReorderHandlerの作成
  - 全タスク取得と移動対象タスクの特定
  - 位置再計算アルゴリズムの呼び出し
  - ストレージへの一括更新処理
  - 更新後の全タスクリストをレスポンスとして返却
  - _Requirements: 4.2, 4.3_

- [x] 3.3 並び替えAPIエンドポイントを追加
  - `PUT /todos/:id/reorder`エンドポイントの作成
  - Honoルーティングへの追加
  - 認証ミドルウェアの適用
  - エラーハンドリングの実装
  - _Requirements: 4.1, 4.3, 4.4, 4.5_

- [ ] 4. フロントエンドUIの実装
- [x] 4.1 ドラッグ&ドロップ機能を実装
  - HTML5 Drag and Drop APIを使用したドラッグ開始処理
  - ドラッグ中の視覚的フィードバック（ドラッグ状態の表示）
  - ドロップ可能位置の視覚的表示
  - ドロップ時の位置計算と並び替えAPI呼び出し
  - ドラッグキャンセル処理（Escキー、無効な位置）
  - _Requirements: 2.1, 2.2, 2.3, 2.4_

- [x] 4.2 タッチデバイス対応のドラッグ&ドロップを実装
  - ロングプレス検出（500ms）でドラッグモード開始
  - Touch Events APIを使用したタッチ操作
  - タッチ中の視覚的フィードバック
  - _Requirements: 2.5_

- [x] 4.3 ボタンによる並び替え機能を実装
  - 各タスク項目に「▲」「▼」ボタンを追加（旧:「上へ移動」「下へ移動」）
  - 最上位タスクでの「▲」ボタン無効化
  - 最下位タスクでの「▼」ボタン無効化
  - ボタンクリック時の並び替えAPI呼び出し
  - _Requirements: 3.1, 3.2, 3.3, 3.4, 3.5_

- [ ] 4.4 キーボード操作とフォーカス管理を実装
  - Ctrl+↑/↓キーでのタスク移動機能
  - Tabキーでのフォーカス移動
  - 視覚的なフォーカスインジケータの表示
  - ボタンへのキーボードフォーカス対応
  - _Requirements: 3.6, 7.2, 7.3, 7.4_

- [ ] 5. 楽観的更新とエラーハンドリングの実装
- [x] 5.1 楽観的更新機能を実装
  - 並び替え操作時の即座のUI更新（100ms以内）
  - ローカルstate更新ロジック
  - バックエンドAPI呼び出しの非同期処理
  - _Requirements: 6.1_

- [x] 5.2 ロールバック機能を実装
  - API呼び出し失敗時の元の状態への復元
  - ネットワークエラー時のロールバック処理
  - ロールバック時のエラーメッセージ表示
  - _Requirements: 6.4, 6.5_

- [ ] 5.3 UIフィードバックとローディング表示を実装
  - API呼び出し中のローディングインジケータ
  - 成功時のフィードバック（アニメーションまたはメッセージ）
  - エラー時のエラーメッセージ表示と再試行オプション
  - スムーズな位置変更アニメーション
  - _Requirements: 6.2, 6.3, 6.4, 6.5, 6.6_

- [ ] 6. アクセシビリティ機能の実装
- [ ] 6.1 スクリーンリーダー対応を実装
  - タスクの現在位置と総数の読み上げ対応（例：「3つ中1番目のタスク」）
  - タスク移動完了時の通知（例：「タスクを2番目に移動しました」）
  - 適切なARIAラベルとロールの設定
  - _Requirements: 7.1, 7.3, 7.5_

- [ ] 6.2 キーボード操作のアクセシビリティを実装
  - ドラッグ&ドロップの代替キーボード操作を提供
  - 並び替えボタンへの適切なARIAラベル設定
  - キーボードショートカットの実装（前タスクで実装済みの場合は検証のみ）
  - _Requirements: 7.2, 7.4, 7.5_

- [ ] 7. パフォーマンス最適化の実装
- [ ] 7.1 フロントエンドのパフォーマンス最適化を実装
  - React.memo()によるコンポーネント最適化
  - useMemo()とuseCallback()によるメモ化
  - CSSアニメーションによる位置変更の表現
  - _Requirements: 8.1_

- [ ] 7.2 API呼び出しのデバウンス/スロットリングを実装
  - 短時間に複数回並び替え操作が発生した場合のリクエスト制御（300ms）
  - 最後の操作のみをAPI送信する機能
  - _Requirements: 8.4_

- [ ] 7.3 大量タスク対応の最適化を実装（オプション）
  - 100個以上のタスクがある場合の仮想スクロール対応
  - 遅延ロード機能
  - _Requirements: 8.2_

- [ ] 8. テストの実装
- [ ] 8.1 並び替えアルゴリズムのユニットテストを実装
  - 上方向移動時の位置再計算テスト
  - 下方向移動時の位置再計算テスト
  - oldPosition == newPositionの場合のテスト
  - position値の連続性テスト
  - _Requirements: 1.1, 4.2_

- [ ] 8.2 バックエンドハンドラーのユニットテストを実装
  - 有効な並び替えリクエストで200 OKを返すテスト
  - 無効なUUID形式で400 Bad Requestを返すテスト
  - 範囲外のnewPositionで400 Bad Requestを返すテスト
  - 存在しないtodoIdで404 Not Foundを返すテスト
  - ストレージエラー時に500 Internal Server Errorを返すテスト
  - _Requirements: 4.1, 4.3, 4.4, 4.5_

- [ ] 8.3 ストレージ層のユニットテストを実装
  - updatePositionsメソッドの正常動作テスト
  - position順のソート検証テスト
  - Workers KV並列書き込みの検証テスト
  - _Requirements: 4.6, 5.1, 5.2_

- [ ] 8.4 フロントエンドコンポーネントのユニットテストを実装
  - ドラッグ開始時のdataTransfer設定テスト
  - ドロップ時のonReorder呼び出しテスト
  - ボタンクリック時のonReorder呼び出しテスト
  - ボタン無効化状態のテスト
  - 楽観的更新とロールバックのテスト
  - _Requirements: 2.1, 2.2, 2.3, 3.1, 3.2, 3.3, 3.4, 3.5, 6.1, 6.4, 6.5_

- [ ] 8.5 統合テストを実装
  - エンドツーエンドの並び替えフロー（ドラッグ&ドロップ）
  - エンドツーエンドの並び替えフロー（ボタン操作）
  - Workers KV統合テスト（position順の取得、並列書き込み）
  - エラーハンドリング統合テスト
  - _Requirements: 4.3, 5.1, 5.3_

- [ ] 8.6 E2E/UIテストを実装
  - ドラッグ&ドロップ操作のE2Eテスト（マウス、タッチ）
  - ボタン操作のE2Eテスト
  - キーボードショートカットのE2Eテスト
  - アクセシビリティテスト（スクリーンリーダー、キーボードナビゲーション）
  - _Requirements: 2.1, 2.2, 2.3, 2.5, 3.1, 3.2, 3.3, 7.1, 7.2, 7.3_

- [ ] 8.7 パフォーマンステストを実装
  - UI更新速度テスト（100ms以内）
  - バックエンドレスポンスタイムテスト（P95: 50ms）
  - 大量タスク（100個以上）でのパフォーマンステスト
  - デバウンス機能のテスト
  - _Requirements: 8.1, 8.2, 8.3, 8.4_

- [ ] 9. 統合とデプロイメント準備
- [ ] 9.1 既存システムとの統合を検証
  - 既存のCRUD操作（作成、取得、更新、削除）が正常に動作することを確認
  - 新規タスク作成時のposition自動割り当ての検証
  - タスク削除時のposition自動調整の検証
  - 既存のエラーハンドリングとの整合性確認
  - _Requirements: 1.2, 1.3_

- [ ] 9.2 後方互換性の検証
  - positionフィールドがない既存Todoタスクの自動マイグレーション検証
  - 既存のクライアントが新しいpositionフィールドを無視できることを確認
  - Workers KV書き込み/読み込みの整合性検証
  - _Requirements: 5.1, 5.2, 5.4_

- [ ] 9.3 マイグレーション戦略の実施準備
  - Phase 1（データモデル拡張）のロールバック手順を文書化
  - Phase 2（バックエンドデプロイ）の検証チェックポイントを準備
  - Phase 3（フロントエンドデプロイ）の検証チェックポイントを準備
  - Phase 4（監視）のメトリクス収集設定
  - _Requirements: 全要件_

---

## 実装の優先順位

1. **フェーズ1（タスク1）**: データモデルとストレージ層の拡張 → 既存システムへの影響を最小化
2. **フェーズ2（タスク2-3）**: バックエンドロジックとAPI実装 → 並び替え機能の中核
3. **フェーズ3（タスク4-6）**: フロントエンドUIとアクセシビリティ → ユーザー体験の提供
4. **フェーズ4（タスク7）**: パフォーマンス最適化 → 要件の達成
5. **フェーズ5（タスク8）**: テストとQA → 品質保証
6. **フェーズ6（タスク9）**: 統合とデプロイメント準備 → リリース準備

## 注意事項

- 各タスクはTDD（テスト駆動開発）の原則に従って実装します
- タスクは順次実行を推奨しますが、一部のタスクは並行実装可能です
- 楽観的更新とロールバックの実装は、ユーザー体験に直結するため重要です
- アクセシビリティ機能は要件に含まれているため、必ず実装してください
- パフォーマンス最適化は、要件8に基づいて実装してください
