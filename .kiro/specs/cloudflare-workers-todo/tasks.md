# 実装タスク

## 概要

本ドキュメントは、Cloudflare Workers Todo アプリケーションの実装タスクを定義します。各タスクは、要件定義書と技術設計書に基づいて構成されており、順次実行することで完全なシステムを構築します。

## タスクリスト

- [x] 1. プロジェクト基盤のセットアップ
- [x] 1.1 プロジェクトの初期化と依存関係のインストール
  - Node.jsプロジェクトを初期化し、必要なパッケージをインストールする
  - Hono、TypeScript、Wranglerなどのコア依存関係を追加する
  - 開発用依存関係（Vitest、Miniflare、ESLint、Prettier等）を設定する
  - package.jsonにスクリプト（dev、build、deploy、test）を定義する
  - _要件: 8.1（エッジロケーション処理）、全要件に必要な基盤_

- [x] 1.2 Wrangler設定ファイルの作成
  - wrangler.tomlファイルを作成し、Workerの基本設定を定義する
  - Workers KVバインディング（TODO_KV）を設定する
  - 互換性日付（compatibility_date）を設定する
  - 開発環境と本番環境の設定を分離する
  - _要件: 5.1（データ永続化にKV使用）、8.1（エッジ処理）_

- [x] 1.3 TypeScript設定とプロジェクト構造の確立
  - tsconfig.jsonを作成し、TypeScriptコンパイラオプションを設定する
  - パスエイリアス（@models、@handlers、@utils等）を定義する
  - ディレクトリ構造（src/、test/、handlers/、middleware/、storage/、utils/、models/）を作成する
  - Cloudflare Workers型定義（@cloudflare/workers-types）をインストールする
  - _要件: 全要件に必要な型安全性の基盤_

- [x] 2. データモデルと型定義の作成
- [x] 2.1 Todoドメインモデルの定義
  - Todo型（id、title、completed、createdAt）を定義する
  - CreateTodoRequestインターフェースを定義する
  - UpdateTodoRequestインターフェースを定義する
  - TodoResponseインターフェースを定義する
  - ビジネスルール（文字数制限、制御文字禁止等）をコメントで記載する
  - _要件: 1.1-1.5（Todo作成）、2.4（Todoフィールド）、13.3（データ構造）_

- [x] 2.2 エラーレスポンス型の定義
  - ErrorResponseインターフェースを定義する
  - エラーコード型（VALIDATION_ERROR、UNAUTHORIZED、NOT_FOUND等）を定義する
  - 標準化されたエラー形式（error.code、error.message）を定義する
  - _要件: 7.2（エラーレスポンス形式）、14.1-14.6（エラーレスポンス標準化）_

- [x] 2.3 環境変数とバインディングの型定義
  - Envインターフェースを定義する
  - TODO_KV（KVNamespace型）バインディングを定義する
  - VALID_API_KEYS、ALLOWED_ORIGINS環境変数を定義する
  - _要件: 5.1（KVバインディング）、10.2（API Key認証）_

- [x] 3. ストレージ層の実装
- [x] 3.1 ストレージインターフェースの定義
  - IStorageインターフェースを定義する
  - CRUD操作メソッド（create、getAll、getById、update、delete）を定義する
  - 各メソッドの契約（事前条件、事後条件、不変条件）をコメントで記載する
  - 将来的なストレージ移行（D1、Durable Objects）を考慮した抽象化を行う
  - _要件: 5.1-5.4（データ永続化）_

- [x] 3.2 Workers KVストレージの実装
  - KVStorageクラスを実装し、IStorageインターフェースを継承する
  - createメソッドを実装（todos:{id}キーにJSON保存）
  - getAllメソッドを実装（KV List APIでキー取得、Promise.allで並行読み込み）
  - getByIdメソッドを実装（KV getでJSON取得、パース）
  - updateメソッドを実装（既存Todo取得、マージ、保存）
  - deleteメソッドを実装（KV delete実行）
  - Eventual Consistency考慮事項をコメントで記載する
  - _要件: 5.1-5.4（データ永続化）、2.1-2.5（Todo取得）_

- [ ] 4. バリデーションユーティリティの実装
- [ ] 4.1 Todo入力バリデーション機能の実装
  - validateTodoInput関数を実装する
  - タイトル検証（必須、string型、1-500文字）を実装する
  - 制御文字検証（\x00-\x1F、\x7Fを拒否）を実装する
  - completed検証（任意、boolean型のみ）を実装する
  - バリデーション結果（valid、error）を返却する
  - _要件: 1.3（タイトル検証）、3.6（更新データ検証）、12.1-12.5（データバリデーション）_

- [ ] 4.2 ID検証機能の実装
  - validateId関数を実装する
  - UUID v4形式の正規表現検証を実装する
  - IDの形式違反時にfalseを返す
  - _要件: 13.1（UUID v4生成）、2.3（ID存在確認）_

- [ ] 4.3 Todo件数制限の検証機能実装
  - validateTodoCount関数を実装する
  - 現在のTodo件数が500件未満であることを確認する
  - 500件に達している場合はTODO_LIMIT_REACHEDエラーを返す
  - 将来的なスケーラビリティ（ページネーション等）を考慮したコメントを記載する
  - _要件: KV List API制限（1000件）に対する余裕確保_

- [ ] 5. レスポンスユーティリティの実装
- [ ] 5.1 標準JSONレスポンス生成機能の実装
  - jsonResponse関数を実装する
  - 任意のデータをJSON形式でレスポンスに変換する
  - Content-Typeヘッダー（application/json）を設定する
  - 適切なHTTPステータスコードを設定する
  - _要件: 6.1-6.5（RESTful API）、全要件に必要なレスポンス生成_

- [ ] 5.2 標準化エラーレスポンス生成機能の実装
  - errorResponse関数を実装する
  - エラーコードとメッセージを受け取り、標準形式のエラーレスポンスを生成する
  - エラー形式（error.code、error.message）に準拠する
  - 詳細なスタックトレースをクライアントに公開しない
  - _要件: 7.1-7.5（エラーハンドリング）、14.1-14.6（エラーレスポンス標準化）_

- [ ] 6. 認証ミドルウェアの実装
- [ ] 6.1 API Key認証ミドルウェアの実装
  - apiKeyAuth関数を実装する
  - X-API-Keyヘッダーの存在確認を行う
  - 環境変数VALID_API_KEYSからカンマ区切りのキーリストを取得する
  - 提供されたAPI Keyが有効なキーリストに含まれるか検証する
  - 認証失敗時に401 Unauthorizedエラーを返す
  - 認証成功時にnext()を呼び出して次のミドルウェアに制御を渡す
  - _要件: 10.1-10.5（認証・認可）_

- [ ] 7. CORSミドルウェアの実装
- [ ] 7.1 CORS設定とプリフライトハンドリングの実装
  - Honoの組み込みCORSミドルウェア（hono/cors）を使用する
  - 環境変数ALLOWED_ORIGINSから許可オリジンリストを取得する
  - 未設定時は'*'（開発用）、本番環境では特定のオリジンを許可する
  - allowMethods（GET、POST、PUT、DELETE、OPTIONS）を設定する
  - allowHeaders（Content-Type、X-API-Key）を設定する
  - プリフライトリクエスト（OPTIONS）を適切に処理する
  - _要件: 9.1-9.3（CORSサポート）_

- [ ] 8. Todoハンドラーの実装
- [ ] 8.1 Todo作成ハンドラーの実装
  - createTodo関数を実装する
  - リクエストボディからタイトルを取得し、バリデーションを実行する
  - バリデーション失敗時に400 Bad Requestエラーを返す
  - 現在のTodo件数を確認し、500件制限を検証する
  - crypto.randomUUID()を使用してUUID v4形式のIDを生成する
  - デフォルト値（completed: false、createdAt: 現在時刻）を設定する
  - ストレージレイヤーのcreateメソッドを呼び出してTodoを保存する
  - 201 Createdステータスで作成されたTodoを返す
  - _要件: 1.1-1.5（Todo作成）、13.1-13.4（ID生成とデータ構造）_

- [ ] 8.2 全Todo取得ハンドラーの実装
  - getTodos関数を実装する
  - ストレージレイヤーのgetAllメソッドを呼び出してすべてのTodoを取得する
  - Todoリストが空の場合は空の配列を返す
  - 200 OKステータスでTodo配列を返す
  - 各Todo項目に完全なスキーマ（id、title、completed、createdAt）が含まれることを確認する
  - _要件: 2.1、2.4-2.5（Todo取得）_

- [ ] 8.3 特定Todo取得ハンドラーの実装
  - getTodoById関数を実装する
  - パスパラメータからIDを取得し、UUID v4形式を検証する
  - ストレージレイヤーのgetByIdメソッドを呼び出してTodoを取得する
  - IDが存在しない場合は404 Not Foundエラーを返す
  - 存在する場合は200 OKステータスでTodoを返す
  - _要件: 2.2-2.3（特定Todo取得）_

- [ ] 8.4 Todo更新ハンドラーの実装
  - updateTodo関数を実装する
  - パスパラメータからIDを取得し、UUID v4形式を検証する
  - リクエストボディから更新データ（title、completed）を取得し、バリデーションを実行する
  - 更新データが空またはnullの場合は400 Bad Requestエラーを返す
  - ストレージレイヤーのupdateメソッドを呼び出してTodoを更新する
  - IDが存在しない場合は404 Not Foundエラーを返す
  - id、createdAtが変更されないことを保証する
  - 200 OKステータスで更新されたTodoを返す
  - _要件: 3.1-3.6（Todo更新）_

- [ ] 8.5 Todo削除ハンドラーの実装
  - deleteTodo関数を実装する
  - パスパラメータからIDを取得し、UUID v4形式を検証する
  - ストレージレイヤーのdeleteメソッドを呼び出してTodoを削除する
  - IDが存在しない場合は404 Not Foundエラーを返す
  - 削除成功時は204 No Contentステータスを返す
  - 削除後、該当IDのTodoが取得不可になることを確認する
  - _要件: 4.1-4.4（Todo削除）_

- [ ] 9. エラーハンドリングミドルウェアの実装
- [ ] 9.1 グローバルエラーハンドラーの実装
  - app.onError()を使用してグローバルエラーハンドラーを登録する
  - 予期しないエラーをキャッチし、標準化されたエラーレスポンスを生成する
  - エラー詳細をconsole.error()でログに記録する
  - スタックトレースをクライアントに公開せず、ログにのみ記録する
  - 500 Internal Serverエラーとしてエラーコード「INTERNAL_ERROR」を返す
  - _要件: 7.1-7.5（エラーハンドリング）、14.6（内部エラー処理）_

- [ ] 10. アプリケーションエントリーポイントの実装
- [ ] 10.1 Honoアプリケーションの初期化とミドルウェア登録
  - Honoアプリケーションを初期化する
  - CORSミドルウェアをすべてのルートに適用する
  - 認証ミドルウェアをすべてのTodo APIルートに適用する
  - エラーハンドリングミドルウェア（app.onError）を登録する
  - ミドルウェアチェーンの順序（CORS → 認証 → エラーハンドリング → ハンドラー）を確保する
  - _要件: 6.1-6.6（RESTful API）、9.1-9.3（CORS）、10.1-10.5（認証）_

- [ ] 10.2 RESTfulルーティングの定義
  - POST /todos ルートを定義し、createTodoハンドラーを紐付ける
  - GET /todos ルートを定義し、getTodosハンドラーを紐付ける
  - GET /todos/:id ルートを定義し、getTodoByIdハンドラーを紐付ける
  - PUT /todos/:id ルートを定義し、updateTodoハンドラーを紐付ける
  - DELETE /todos/:id ルートを定義し、deleteTodoハンドラーを紐付ける
  - サポートされていないメソッドの場合は405 Method Not Allowedを自動返却する
  - _要件: 6.1-6.6（RESTful API）_

- [ ] 10.3 Workers KVバインディングの統合とWorkerエクスポート
  - ストレージレイヤーをHonoコンテキストから初期化する
  - KVStorageインスタンスを生成し、c.env.TODO_KVを渡す
  - Honoアプリケーションをデフォルトエクスポートする
  - Workers環境で正しく動作することを確認する
  - _要件: 5.1-5.4（データ永続化、KVバインディング）_

- [ ] 11. テスト環境のセットアップ
- [ ] 11.1 Vitestとテスト設定の構成
  - vitest.config.tsを作成し、Miniflare環境を設定する
  - Workers KVバインディング（TODO_KV）をテスト環境に設定する
  - テスト用の環境変数（VALID_API_KEYS等）を設定する
  - カバレッジレポート設定を追加する
  - _要件: 全要件のテストに必要な基盤_

- [ ] 12. ユニットテストの実装
- [ ] 12.1 バリデーションユーティリティのテスト
  - タイトル検証のテスト（空文字、501文字、制御文字、正常値）を実装する
  - ID検証のテスト（無効なUUID、UUID v4以外、正常値）を実装する
  - Todo件数制限のテスト（499件、500件、501件）を実装する
  - completed検証のテスト（真偽値以外、正常値）を実装する
  - _要件: 12.1-12.5（データバリデーション）_

- [ ] 12.2 ストレージレイヤーのテスト
  - createメソッドのテスト（個別Todo保存、KVキー確認）を実装する
  - getAllメソッドのテスト（KV List API使用、並行読み込み確認）を実装する
  - getByIdメソッドのテスト（存在するID、存在しないID）を実装する
  - updateメソッドのテスト（部分更新、id/createdAt不変性）を実装する
  - deleteメソッドのテスト（削除成功、存在しないID）を実装する
  - _要件: 5.1-5.4（データ永続化）_

- [ ] 12.3 Todoハンドラーのテスト
  - createTodoのテスト（UUID生成、デフォルト値、バリデーションエラー）を実装する
  - getTodosのテスト（空配列、複数Todo）を実装する
  - getTodoByIdのテスト（存在するID、404エラー）を実装する
  - updateTodoのテスト（部分更新、バリデーションエラー、404エラー）を実装する
  - deleteTodoのテスト（削除成功、404エラー）を実装する
  - _要件: 1.1-1.5（Todo作成）、2.1-2.5（Todo取得）、3.1-3.6（Todo更新）、4.1-4.4（Todo削除）_

- [ ] 13. 統合テストの実装
- [ ] 13.1 認証フローのテスト
  - 有効なAPI Key → 200 OKのテストを実装する
  - 無効なAPI Key → 401 Unauthorizedのテストを実装する
  - API Key欠落 → 401 Unauthorizedのテストを実装する
  - _要件: 10.1-10.5（認証・認可）_

- [ ] 13.2 CRUD操作フローのテスト
  - POST /todos → 201 Created → GET /todos/:id → 同一データ確認のテストを実装する
  - PUT /todos/:id → 200 OK → GET /todos/:id → 更新確認のテストを実装する
  - DELETE /todos/:id → 204 No Content → GET /todos/:id → 404確認のテストを実装する
  - GET /todos → 複数Todo取得確認のテストを実装する
  - _要件: 1.1-1.5（作成）、2.1-2.5（取得）、3.1-3.6（更新）、4.1-4.4（削除）_

- [ ] 13.3 エラーハンドリングフローのテスト
  - 無効なJSON → 400 Bad Requestのテストを実装する
  - 存在しないID → 404 Not Foundのテストを実装する
  - サポートされていないメソッド → 405 Method Not Allowedのテストを実装する
  - 予期しないエラー → 500 Internal Server Errorのテストを実装する
  - エラーレスポンス形式（error.code、error.message）の検証を実装する
  - _要件: 7.1-7.5（エラーハンドリング）、14.1-14.6（エラーレスポンス標準化）_

- [ ] 13.4 CORSフローのテスト
  - OPTIONSリクエスト → CORSヘッダー確認のテストを実装する
  - クロスオリジンリクエスト → Access-Control-Allow-Origin確認のテストを実装する
  - _要件: 9.1-9.3（CORSサポート）_

- [ ] 14. 最終統合とデプロイ準備
- [ ] 14.1 ローカル開発環境での動作確認
  - wrangler devコマンドでローカルサーバーを起動する
  - すべてのAPIエンドポイント（POST、GET、PUT、DELETE）が正常に動作することを確認する
  - 認証、CORS、エラーハンドリングが期待通りに動作することを確認する
  - Miniflareを使用してWorkers KVとの統合が正常に機能することを確認する
  - _要件: 全要件の統合確認_

- [ ] 14.2 デプロイメント設定とシークレット管理の構成
  - KV Namespaceを作成（開発環境、本番環境）する
  - wrangler secret putコマンドでVALID_API_KEYSを設定する
  - 本番環境のALLOWED_ORIGINS（特定オリジンのみ許可）を設定する
  - wrangler.tomlの環境別設定（開発、本番）を確認する
  - .gitignoreに環境変数ファイル（.env等）を追加する
  - _要件: 10.1-10.5（認証）、9.1-9.3（CORS）_

- [ ] 14.3 ステージング環境へのデプロイと動作確認
  - wrangler deployコマンドでステージング環境にデプロイする
  - デプロイ後のURL（*.workers.dev）でAPIが正常に動作することを確認する
  - curlまたはPostmanを使用してすべてのエンドポイントをテストする
  - Cloudflare Workersダッシュボードでログとメトリクスを確認する
  - パフォーマンス（レスポンスタイム < 200ms P95）を測定する
  - _要件: 8.1-8.4（パフォーマンスとスケーラビリティ）_

- [ ] 14.4 ドキュメントの作成とリポジトリの整備
  - README.mdを作成し、プロジェクト概要、セットアップ手順、API仕様を記載する
  - API仕様ドキュメント（エンドポイント、リクエスト/レスポンス形式、エラーコード）を作成する
  - デプロイ手順書（wrangler deploy、シークレット設定等）を作成する
  - 環境変数一覧とその説明を文書化する
  - コントリビューションガイドライン（コード規約、テスト方針等）を作成する
  - _要件: 全要件の文書化_

## タスク実行順序

タスクは上記の番号順に実行してください。各メジャータスクは、前のタスクの成果物に依存しています。サブタスクは並行して実行できる場合もありますが、基本的には順次実行を推奨します。

### 依存関係

- タスク2以降は、タスク1（プロジェクト基盤）の完了が必要です
- タスク8（Todoハンドラー）は、タスク3（ストレージ）、タスク4（バリデーション）、タスク5（レスポンス）の完了が必要です
- タスク10（エントリーポイント）は、タスク6（認証）、タスク7（CORS）、タスク8（ハンドラー）、タスク9（エラーハンドリング）の完了が必要です
- タスク12（ユニットテスト）は、タスク11（テスト環境）の完了が必要です
- タスク13（統合テスト）は、タスク10（エントリーポイント）とタスク11（テスト環境）の完了が必要です
- タスク14（最終統合）は、すべてのタスクの完了が必要です

## 要件カバレッジ

すべての要件が以下のタスクでカバーされています：

| 要件 | 対応タスク |
|------|----------|
| 要件1: Todo項目の作成 | 8.1 |
| 要件2: Todo項目の取得 | 8.2, 8.3 |
| 要件3: Todo項目の更新 | 8.4 |
| 要件4: Todo項目の削除 | 8.5 |
| 要件5: データ永続化 | 1.2, 3.1, 3.2, 10.3 |
| 要件6: RESTful API | 10.1, 10.2 |
| 要件7: エラーハンドリング | 5.2, 9.1, 13.3 |
| 要件8: パフォーマンスとスケーラビリティ | 1.1, 14.3（Cloudflare Workersの特性を活用） |
| 要件9: CORSサポート | 7.1, 13.4 |
| 要件10: 認証・認可 | 6.1, 13.1 |
| 要件11: DoS保護とレート制限 | Cloudflare機能（Bot Management、無料枠制限）でカバー |
| 要件12: データバリデーション | 4.1, 4.2, 12.1 |
| 要件13: ID生成とデータ構造 | 2.1, 8.1 |
| 要件14: エラーレスポンスの標準化 | 2.2, 5.2, 13.3 |

## 実装上の注意事項

### TDD（テスト駆動開発）アプローチ

本プロジェクトではTDDアプローチを推奨します：
1. まず、ユニットテスト（タスク12）を実装し、期待される動作を定義する
2. 次に、実装（タスク3-10）を行い、テストをパスさせる
3. 統合テスト（タスク13）で全体の動作を確認する

### コード品質

- TypeScriptの型安全性を最大限に活用する
- ESLintとPrettierでコード品質を維持する
- すべての関数に適切なコメント（JSDoc形式推奨）を記載する
- エッジケースとエラーハンドリングを十分に考慮する

### パフォーマンス

- Workers KVのEventual Consistencyを考慮する
- 並行処理（Promise.all）を活用して読み込みを高速化する
- バンドルサイズを最小化し、起動時間を短縮する

### セキュリティ

- API Keyやシークレットを絶対にコードリポジトリにコミットしない
- ログにセンシティブデータ（API Key、エラー詳細等）を含めない
- 入力検証を徹底し、XSS、インジェクション攻撃を防止する
